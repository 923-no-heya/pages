<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>9 × 2 = 3 の部屋</title>
  <meta name="description" content="" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f172a;            /* 深い藍 */
      --surface:rgba(15,23,42,.6);
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(148,163,184,.35);
      --brand:#60a5fa;         /* 水色 */
      --brand-2:#22d3ee;       /* シアン */
      --radius:20px;
      --shadow:0 10px 30px rgba(2,6,23,.35);
      --max:1200px;
      --chip:rgba(226,232,240,.06);
      --chip-hover:rgba(226,232,240,.16);
      --glow:0 0 0 1px rgba(96,165,250,.25), 0 8px 24px rgba(2,132,199,.25) inset;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.65 Inter,"Noto Sans JP",sans-serif;color:var(--ink);background:
      radial-gradient(1200px 800px at 10% 0%, rgba(56,189,248,.15), transparent 60%),
      radial-gradient(900px 600px at 90% -10%, rgba(99,102,241,.18), transparent 60%),
      #0b1020;
      background-attachment: fixed;
    }
    a{text-decoration:none;color:inherit}
    .container{max-width:var(--max);margin:0 auto;padding:0 32px}

    /* Header (glass / blur) */
    header{
      position:sticky; top:0; z-index:50;
      background:var(--surface);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid rgba(148,163,184,.18);
    }
    .nav{display:flex;align-items:center;gap:16px;padding:14px 32px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;font-size:18px;
      background:linear-gradient(90deg,var(--brand),var(--brand-2));
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .brand-svg{width:22px;height:22px;display:block;color:#93c5fd}
    .spacer{flex:1}

    /* Tabs (gradient border + moving indicator) */
    .tabsWrap{position:relative}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;position:relative;padding:6px;border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow:var(--glow);
    }
    .tab{
      position:relative;
      padding:10px 14px;border-radius:12px;font-weight:600;color:var(--ink);
      transition:.18s transform ease, .18s background ease, .18s color ease;
      background:transparent;
      border:1px solid transparent;
      overflow:hidden;
    }
    .tab::after{
      content:""; position:absolute; left:12px; right:12px; bottom:6px; height:2px;
      background:linear-gradient(90deg,var(--brand),var(--brand-2));
      transform:scaleX(0); transform-origin:left; transition:transform .22s ease;
    }
    .tab:hover{background:var(--chip-hover); transform:translateY(-1px)}
    .tab:hover::after{transform:scaleX(1)}
    .tab[aria-current="page"]{
      color:#0b1020; background:linear-gradient(90deg,var(--brand),var(--brand-2));
      box-shadow:0 6px 20px rgba(34,211,238,.25);
    }
    .indicator{
      position:absolute; height:40px; border-radius:12px; z-index:0;
      background:radial-gradient(600px 60px at var(--x,50%) 50%, rgba(34,211,238,.15), transparent 60%);
      pointer-events:none; transition:all .25s ease;
    }

    /* Mobile menu button */
    .menuButton{display:none;background:none;border:none;cursor:pointer;padding:8px}
    .menuIcon{width:24px;height:2px;background:var(--ink);position:relative;display:block;border-radius:1px}
    .menuIcon::before,.menuIcon::after{content:"";position:absolute;left:0;width:24px;height:2px;background:var(--ink);border-radius:1px}
    .menuIcon::before{top:-7px}
    .menuIcon::after{top:7px}
    @media(max-width:980px){.tabsWrap{display:none}.menuButton{display:inline-flex;align-items:center;justify-content:center}}

    /* Drawer (frosted) */
    .drawer{
      position:fixed; inset:0 0 0 auto; width:84%; max-width:340px; transform:translateX(100%);
      background:linear-gradient(180deg, rgba(15,23,42,.8), rgba(15,23,42,.6));
      backdrop-filter: blur(10px); box-shadow:var(--shadow); transition:.25s; display:flex; flex-direction:column;
      padding:22px 18px; gap:10px; z-index:60; border-left:1px solid rgba(148,163,184,.2)
    }
    .drawer.open{transform:translateX(0)}
    .drawer a{
      padding:12px 14px; border-radius:12px; background:rgba(226,232,240,.06); border:1px solid rgba(148,163,184,.2);
      font-weight:600; color:var(--ink); transition:.18s; display:flex; align-items:center; gap:10px;
    }
    .drawer a:hover{background:rgba(226,232,240,.16)}
    .drawer .dTitle{color:#a5b4fc;font-weight:800;padding:8px 6px 4px}

    /* Hero */
    main{min-height:70vh}
    .hero{position:relative;color:#fff;text-align:center;padding:120px 32px;overflow:hidden}
    .hero-background{position:absolute;inset:-10% 0 0 0;width:100%;height:120%;object-fit:cover;z-index:-1;filter:brightness(0.5) saturate(115%)}
    .hero h1{font-size:clamp(32px,6vw,52px);margin:0 0 12px;font-weight:800}
    .ctaRow{margin-top:22px;display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
    .btn{padding:12px 18px;border-radius:12px;font-weight:700;transition:.2s;display:inline-block}
    .btn.primary{background:#fff;color:#0b1020}
    .btn.secondary{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.5)}
    .btn:hover{opacity:.9}

    /* Sections / Cards */
    .catSection{padding:60px 32px;position:relative}
    .catHeader{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;margin:0 0 24px}
    .catHeader h2{margin:0;font-size:28px;font-weight:800;background:linear-gradient(90deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .catHeader p{flex-basis:100%;margin:8px 0 0;color:var(--muted)}
    .viewAll{padding:8px 14px;border-radius:10px;border:1px solid var(--line);background:rgba(226,232,240,.06);color:var(--brand);font-weight:700}
    .cardGrid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}

    /* Unified Card */
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.25);
      border-radius:16px;box-shadow:var(--shadow);padding:22px;display:flex;flex-direction:column;gap:8px;transition:all .2s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 10px 28px rgba(2,6,23,.55)}
    .cardTitle{margin:0;font-size:20px;font-weight:700}
    .cardDesc{color:var(--muted);display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
    .cardMore{margin-top:auto;color:var(--brand);font-weight:700}

    /* PDF list with descriptions */
    .pdfList{list-style:none;padding:0;margin:0;display:grid;gap:12px}
    .pdfItem{border:1px solid rgba(148,163,184,.25);border-radius:12px;background:rgba(226,232,240,.06);padding:12px 14px}
    .pdfItemTitle{font-weight:700;margin:0 0 6px}
    .pdfItemTitle a{color:#e5e7eb}
    .pdfItemTitle a:hover{text-decoration:underline}
    .pdfItemDesc{color:var(--muted);margin:0}

    /* Footer */
    footer{padding:32px;text-align:center;color:#9ca3af;background:rgba(226,232,240,.04);border-top:1px solid rgba(148,163,184,.18);margin-top:60px}
  </style>
</head>
<body>
  <header>
    <nav class="nav container">
      <a class="brand" href="#/" aria-label="トップへ">
        <!-- インライン SVG（折れ線グラフ） -->
        <svg class="brand-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M3 19a1 1 0 0 0 1 1h16v-2H5V5H3v14Zm18-9-4.5 4.5-3-3L8 17l-1.5-1.5 6-6 3 3L19 8l2 2Z"/>
        </svg>
        <span>9 × 2 = 3 の部屋</span>
      </a>

      <div class="spacer"></div>

      <!-- desktop tabs -->
      <div class="tabsWrap">
        <div class="tabs" id="tabs"></div>
        <div class="indicator" id="indicator" style="opacity:.0"></div>
      </div>

      <!-- mobile menu -->
      <button class="menuButton" id="menuBtn" aria-label="メニュー"><span class="menuIcon"></span></button>
    </nav>
  </header>

  <aside id="drawer" class="drawer"></aside>
  <main id="app"></main>
  <footer>© <span id="year"></span> 9 × 2 = 3 の部屋</footer>

  <!-- サイトデータ -->
  <script src="site-data.js"></script>

  <script>
    const $ = s => document.querySelector(s);

    /* ==== Routing ==== */
    function route(){
      window.scrollTo({top:0, left:0, behavior:'auto'});
      const hash = location.hash || "#/";
      const app = $("#app");
      const parts = hash.split("/");
      const root = parts[1] || "";
      const p1 = parts[2] || "";
      const p2 = parts[3] || "";

      if(root===""||root==="#"){renderHome(app);highlightTab('#/');return}
      if(root==="category" && p1 && !p2){renderCategory(app,p1);highlightTab('#/category/'+p1);return}
      if(root==="subcategory" && p1 && p2){renderSubcategory(app,p1,p2);highlightTab('#/category/'+p1);return}
      if(root==="article" && p1){renderArticle(app,p1);return}
      app.innerHTML="<p style='padding:40px'>ページが見つかりません</p>";
    }

    function highlightTab(path){
      const tabs = document.querySelectorAll('.tabs .tab');
      let activeEl = null;
      tabs.forEach(a=>{
        a.removeAttribute('aria-current');
        if(a.getAttribute('href')===path){ a.setAttribute('aria-current','page'); activeEl=a; }
      });
      moveIndicator(activeEl);
    }

    /* ==== Common UI ==== */
    function buildMenus(){
      const tabsHTML = `
        <a class="tab" href="#/">トップ</a>
        <a class="tab" href="#/category/stat">統計学</a>
        <a class="tab" href="#/category/math">数学</a>
        <a class="tab" href="#/category/queue">待ち行列</a>
        <a class="tab" href="#/category/semiconductor">半導体</a>
        <a class="tab" href="#/category/others">その他の解析</a>
        <a class="tab" href="#/category/melas">走れメラス</a>
        <a class="tab" href="#/category/memoir">手記</a>`;
      $("#tabs").innerHTML = tabsHTML;

      // drawer
      const icon = (d)=>`<svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="${d}"/></svg>`;
      const book = "M6 4h11a2 2 0 0 1 2 2v12a1 1 0 0 1-1 1H8a3 3 0 0 0-3 3V6a2 2 0 0 1 2-2Zm0 0v13a3 3 0 0 1 3-3h9";
      const calc = "M7 3h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Zm2 4h6v2H9V7Zm0 4h6v2H9v-2Zm0 4h6v2H9v-2Z";
      const wave = "M3 12c2 0 2-6 4-6s2 6 4 6 2-6 4-6 2 6 4 6";
      const chip = "M8 4h8v16H8z M4 8h16 M4 16h16 M8 4v16 M16 4v16";
      const queue = "M3 6h14v2H3V6Zm0 5h18v2H3v-2Zm0 5h12v2H3v-2Z";
      const essay = "M6 4h10l4 4v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Zm10 0v4h4";
      const memo = "M5 4h14v12a4 4 0 0 1-4 4H5V4Zm4 5h6M9 13h6";

      const drawerHTML = `
        <div class="dTitle">メニュー</div>
        <a href="#/"><span>${icon(book)}</span>トップ</a>
        <a href="#/category/stat"><span>${icon(calc)}</span>統計学</a>
        <a href="#/category/math"><span>${icon(calc)}</span>数学</a>
        <a href="#/category/queue"><span>${icon(queue)}</span>待ち行列</a>
        <a href="#/category/semiconductor"><span>${icon(chip)}</span>半導体</a>
        <a href="#/category/others"><span>${icon(wave)}</span>その他の解析</a>
        <a href="#/category/melas"><span>${icon(essay)}</span>走れメラス</a>
        <a href="#/category/memoir"><span>${icon(memo)}</span>手記</a>`;
      $("#drawer").innerHTML = drawerHTML;

      // 初回のアクティブインジケータ位置
      requestAnimationFrame(()=>highlightTab(location.hash || "#/"));
    }

    /* ===== Moving indicator under tabs ===== */
    function moveIndicator(active){
      const indicator = $("#indicator");
      const wrap = $("#tabs");
      if(!indicator || !wrap){return}
      if(!active){ indicator.style.opacity = .0; return; }
      const r = active.getBoundingClientRect();
      const w = wrap.getBoundingClientRect();
      const left = r.left - w.left + 6;   // padding分微調整
      const width = r.width - 12;
      indicator.style.opacity = .9;
      indicator.style.transform = `translateX(${left}px)`;
      indicator.style.width = `${width}px`;
      indicator.style.setProperty('--x', `${(r.left + r.width/2 - w.left)/w.width*100}%`);
    }
    window.addEventListener('resize', ()=>moveIndicator(document.querySelector('.tab[aria-current="page"]')));

    /* ===== Cards ===== */
    function SubcatCard(parentKey, sc){
      return `
        <a class="card" href="#/subcategory/${parentKey}/${sc.key}">
          <h3 class="cardTitle">${sc.label}</h3>
          <div class="cardDesc">${sc.summary || ''}</div>
          <span class="cardMore">もっと見る →</span>
        </a>`;
    }

    function ArticleCard(a){
      const inner = `
        <h3 class="cardTitle">${a.title}</h3>
        <div class="cardDesc">${a.description || ''}</div>
        <span class="cardMore">本文を見る →</span>`;
      if(a.url){
        return `<a class="card" href="${a.url}">${inner}</a>`;
      }
      return `<div class="card">${inner}</div>`;
    }

    /* ===== Home ===== */
    function renderHome(app){
      let html=`
        <section class="hero">
          <img src="https://kunisan-assets.s3.ap-northeast-1.amazonaws.com/%E3%82%B9%E3%82%A4%E3%82%B9.jpg" alt="著者と牛の写真" class="hero-background" id="hero-bg">
          <h1>${SITE.title}</h1>
          <div class="ctaRow">
            <a class="btn secondary" href="https://kunisan-assets.s3.ap-northeast-1.amazonaws.com/%E8%91%97%E8%80%85%E7%95%A5%E6%AD%B4.pdf">著者略歴</a>
          </div>
        </section>`;

      // 「すべて見る」を隠すカテゴリ
      const hideViewAllKeys = new Set(["stat","math","memoir","others","queue","semiconductor"]);

      html += SITE.categories.map(c=>{
        let inner = "";
        if (c.subcategories) {
          inner = c.subcategories.map(sc=>SubcatCard(c.key, sc)).join("");
        } else if (c.articles) {
          // 走れメラスは末尾3件を降順で表示
          let list = c.articles;
          if (c.key === "melas") {
            list = [].concat(c.articles).slice(-3).reverse();
          }
          inner = list.map(ArticleCard).join("");
        }

        return `
          <section class="catSection container" id="${c.key}">
            <div class="catHeader">
              <h2>${c.label}</h2>
              ${hideViewAllKeys.has(c.key) ? "" : `<a class="viewAll" href="#/category/${c.key}">すべて見る</a>`}
              <p>${c.summary || ''}</p>
            </div>
            <div class="cardGrid">${inner || `<div class="card"><h3 class="cardTitle">コンテンツがありません</h3><div class="cardDesc">公開までお待ちください。</div></div>`}</div>
          </section>`;
      }).join("");

      app.innerHTML=html;

      // パララックス
      const bg = document.getElementById('hero-bg');
      if(bg){
        const onScroll = () => {
          const y = window.scrollY || 0;
          bg.style.transform = `translateY(${y * 0.15}px)`;
        };
        window.addEventListener('scroll', onScroll, { passive: true });
        renderHome._cleanup = () => window.removeEventListener('scroll', onScroll);
      }
    }

    /* ===== Category page ===== */
    function renderCategory(app,key){
      if(renderHome._cleanup){ try{renderHome._cleanup();}catch(e){} }

      const cat = SITE.categories.find(c=>c.key===key);
      if(!cat){app.innerHTML="<p style='padding:40px'>カテゴリが見つかりません</p>";return}

      if(cat.subcategories){
        app.innerHTML = `
          <section class="catSection container">
            <div class="catHeader">
              <h2>${cat.label}</h2>
              <p>${cat.summary||''}</p>
            </div>
            <div class="cardGrid">
              ${cat.subcategories.map(sc=>SubcatCard(cat.key, sc)).join('')}
            </div>
          </section>`;
        return;
      }

      const list=(cat.articles||[]);
      app.innerHTML=`
        <section class="catSection container">
          <div class="catHeader">
            <h2>${cat.label}</h2>
            <p>${cat.summary||''}</p>
          </div>
          <div class="cardGrid">
            ${list.map(ArticleCard).join('')}
          </div>
        </section>`;
    }

    /* ===== Subcategory page ===== */
    function renderSubcategory(app, parentKey, subKey){
      if(renderHome._cleanup){ try{renderHome._cleanup();}catch(e){} }

      const cat = SITE.categories.find(c=>c.key===parentKey);
      if(!cat){ app.innerHTML="<p style='padding:40px'>セクションが見つかりません</p>"; return; }

      let level = 1;
      let parentSC = null;
      let node = (cat.subcategories && cat.subcategories.find(function(s){return s.key===subKey;})) || null;

      if(!node && cat.subcategories){
        for(var i=0;i<cat.subcategories.length;i++){
          var sc = cat.subcategories[i];
          if(sc.children){
            var child = sc.children.find(function(ch){return ch.key===subKey;});
            if(child){
              level = 2;
              parentSC = sc;
              node = child;
              break;
            }
          }
        }
      }

      if(!node){
        app.innerHTML = "<p style='padding:40px'>セクションが見つかりません</p>";
        return;
      }

      if(level===1 && node.children && node.children.length){
        app.innerHTML = `
          <section class='catSection container'>
            <div class='catHeader'>
              <h2>${node.label}</h2>
              <p>${node.summary || cat.summary || ''}</p>
            </div>
            <div class="cardGrid">
              ${node.children.map(function(ch){
                return `
                  <a class="card" href="#/subcategory/${cat.key}/${ch.key}">
                    <h3 class="cardTitle">${ch.label}</h3>
                    <div class="cardDesc">${ch.summary || ''}</div>
                    <span class="cardMore">もっと見る →</span>
                  </a>`;
              }).join('')}
            </div>
          </section>`;
        return;
      }

      var articles = node.articles || [];
      app.innerHTML = `
        <section class='catSection container'>
          <div class='catHeader'>
            <h2>${node.label}</h2>
            <p>${node.summary || cat.summary || ''}</p>
          </div>
          <ul class='pdfList'>
            ${articles.map(function(item){
              var desc = item.description ? `<p class="pdfItemDesc">${item.description}</p>` : '';
              return `<li class="pdfItem">
                        <p class="pdfItemTitle"><a href='${item.url}'>${item.title}</a></p>
                        ${desc}
                      </li>`;
            }).join('')}
          </ul>
        </section>`;
    }

    /* ===== (legacy) Internal Article page ===== */
    function renderArticle(app,id){
      const cat = SITE.categories.find(function(c){
        return (c.articles||[]).some(function(a){return a.id===id;});
      });
      const a = cat && cat.articles ? cat.articles.find(function(x){return x.id===id;}) : null;
      if(!a){app.innerHTML="<p style='padding:40px'>記事が見つかりません</p>";return}
      app.innerHTML=`<article class='container'><h1>${a.title}</h1><div>${a.body||''}</div></article>`;
    }

    /* ===== Drawer ===== */
    const drawer=$("#drawer"),menuBtn=$("#menuBtn");
    menuBtn.addEventListener("click",()=>drawer.classList.toggle("open"));
    drawer.addEventListener("click",e=>{if(e.target.tagName==="A")drawer.classList.remove("open")});

    window.addEventListener("hashchange",route);
    window.addEventListener("DOMContentLoaded",()=>{
      if(!window.SITE){ console.error("SITE が見つかりません。先に site-data.js を読み込んでください。"); }
      buildMenus();
      route();
      $("#year").textContent=new Date().getFullYear();
    });
  </script>
</body>
</html>
